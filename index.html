// server.js
const express = require("express");
const path = require("path");
const fs = require("fs");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");
const cors = require("cors");

const app = express();
const PORT = 3000;
const DATA_FILE = path.join(__dirname, "data.json");
const JWT_SECRET = "super_secret_key";

// Middleware
app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, "public")));

// Init file db
function initDB() {
  if (!fs.existsSync(DATA_FILE)) {
    fs.writeFileSync(DATA_FILE, JSON.stringify({ users: [], complaints: [] }, null, 2));
  }
}
function readDB() { return JSON.parse(fs.readFileSync(DATA_FILE, "utf8")); }
function writeDB(data) { fs.writeFileSync(DATA_FILE, JSON.stringify(data, null, 2)); }
initDB();

// Default admin
(function ensureAdmin(){
  const db = readDB();
  if (!db.users.find(u=>u.email==="admin@example.com")) {
    const hashed = bcrypt.hashSync("admin123", 10);
    db.users.push({ id: Date.now(), email:"admin@example.com", password:hashed, role:"admin" });
    writeDB(db);
    console.log("Admin created: admin@example.com / admin123");
  }
})();

// JWT auth
function auth(req,res,next){
  const token = req.headers.authorization?.split(" ")[1];
  if (!token) return res.status(401).json({error:"No token"});
  jwt.verify(token, JWT_SECRET, (err,user)=>{
    if (err) return res.status(401).json({error:"Invalid token"});
    req.user=user; next();
  });
}

// API
app.post("/api/signup",(req,res)=>{
  const {email,password,role}=req.body;
  const db=readDB();
  if(db.users.find(u=>u.email===email)) return res.status(400).json({error:"Email exists"});
  const hashed=bcrypt.hashSync(password,10);
  db.users.push({id:Date.now(),email,password:hashed,role});
  writeDB(db);
  res.json({success:true});
});

app.post("/api/login",(req,res)=>{
  const {email,password}=req.body;
  const db=readDB();
  const user=db.users.find(u=>u.email===email);
  if(!user || !bcrypt.compareSync(password,user.password)) return res.status(401).json({error:"Invalid"});
  const token=jwt.sign({id:user.id,email:user.email,role:user.role},JWT_SECRET,{expiresIn:"8h"});
  res.json({token,role:user.role,email:user.email});
});

app.get("/api/complaints",auth,(req,res)=>{
  const db=readDB();
  if(req.user.role==="student") return res.json(db.complaints.filter(c=>c.createdBy===req.user.email));
  res.json(db.complaints);
});

app.post("/api/complaints",auth,(req,res)=>{
  const {category,priority,details}=req.body;
  if(req.user.role!=="student") return res.status(403).json({error:"Students only"});
  const db=readDB();
  const complaint={id:Date.now(),category,priority,details,status:"Submitted",
    createdBy:req.user.email,createdAt:new Date().toISOString(),resolvedAt:null,feedback:null};
  db.complaints.push(complaint); writeDB(db);
  res.json(complaint);
});

app.put("/api/complaints/:id",auth,(req,res)=>{
  const {status}=req.body;
  const db=readDB();
  const cmp=db.complaints.find(c=>c.id==req.params.id);
  if(!cmp) return res.status(404).json({error:"Not found"});
  if(req.user.role!=="staff" && req.user.role!=="admin") return res.status(403).json({error:"Forbidden"});
  cmp.status=status;
  if(status==="Resolved") cmp.resolvedAt=new Date().toISOString();
  writeDB(db);
  res.json(cmp);
});

// Feedback (students only after resolution)
app.post("/api/complaints/:id/feedback",auth,(req,res)=>{
  const {rating,comment}=req.body;
  const db=readDB();
  const cmp=db.complaints.find(c=>c.id==req.params.id);
  if(!cmp) return res.status(404).json({error:"Not found"});
  if(req.user.email!==cmp.createdBy) return res.status(403).json({error:"Not your complaint"});
  if(cmp.status!=="Resolved") return res.status(400).json({error:"Not resolved"});
  cmp.feedback={rating,comment};
  writeDB(db);
  res.json({success:true,feedback:cmp.feedback});
});

// Analytics
app.get("/api/analytics",auth,(req,res)=>{
  if(req.user.role!=="admin") return res.status(403).json({error:"Admin only"});
  const db=readDB();
  const categories={}, priorities={};
  let ratings=[], resolvedCount=0, totalHours=0;
  db.complaints.forEach(c=>{
    categories[c.category]=(categories[c.category]||0)+1;
    priorities[c.priority]=(priorities[c.priority]||0)+1;
    if(c.resolvedAt){
      resolvedCount++;
      totalHours+=(new Date(c.resolvedAt)-new Date(c.createdAt))/(1000*3600);
    }
    if(c.feedback) ratings.push(c.feedback.rating);
  });
  res.json({
    total:db.complaints.length,
    categories, priorities,
    avgResolution: resolvedCount?totalHours/resolvedCount:null,
    avgRating: ratings.length? ratings.reduce((a,b)=>a+b)/ratings.length : null
  });
});

app.get("*",(req,res)=>res.sendFile(path.join(__dirname,"public/index.html")));
app.listen(PORT,()=>console.log("Server http://localhost:"+PORT));
index.ht
